# 002 - Modèle Conceptuel de Données DiaLog

* Date : 2022-11-09
* Modifié le : 2023-02-28
* Personnes impliquées : Mathieu Marchois, Florimond Manca
* Statut : Accepté

## Contexte

Dans le cadre du projet DiaLog, nous sommes amenés à numériser les arrêtés de circulation. Nous avons procédé à une [analyse de l'existant](https://github.com/MTES-MCT/dialog/wiki/Analyse-de-l'existant) afin de mieux cerner la problématique métier et les différents acteurs.
Après avoir échangé avec différents calculateurs d'itinéraire comme TomTom, Here (compte rendu disponible [içi](https://pad.incubateur.net/s/uNxJar9q8#2022-10-25---TomTom-amp-Here)), il s'avère que le format qui revient le plus souvent est le [DATEXII](https://www.datex2.eu/) qui est un standard européen qui permet représenter un arrêté de circulation.

## Décision

Nous avons décidé d'orienter notre _modèle conceptuel de données_ (MCD) de telle manière qu'il puisse stocker les différentes informations relative au format DATEXII en plus de ceux qui sont plus spécifiques au fonctionnement de DiaLog comme `User` ou `Organization`.


```mermaid
classDiagram
direction TB

class User {
    id*: uuid
}

class Organization {
    siret*: char[14]
    name: varchar[255]
}

class RegulationOrderRecord {
    id*: uuid
    created_at: datetime
    status: enum["draft", "published"]
}

class RegulationOrder {
    id*: uuid
    description: text
    issuing_authority: varchar[255]
    regulation_id: varchar[255]
}

class RegulationCondition {
    id*: uuid
    negate?: boolean
}

class VehicleCharacteristics {
    id*: uuid
    type: enum
    max_weight?: float
    max_height?: float
    max_length?: float
    max_width?: float
    vehicle_usage?: enum
    critair?: tinyint
}
%% DATEX II: VehicleCharacteristics.critair := Emissions.emissionClassificationOther

class Location {
    id*: uuid
    postal_code: varchar[5]
    city: varchar[255]
    road_name: varchar[255]
    from_house_number: varchar[8]
    from_point: geometry
    to_house_number: varchar[8]
    to_point: geometry
}

class ConditionSet {
    id*: uuid
    operator: enum["and", "or", "xor"]
}

class OverallPeriod {
    id*: uuid
    start_date: datetime
    start_time?: datetime
    end_date?: datetime
    end_time?: datetime
}

class Period {
    id*: uuid
    name?: varchar[255]
    start_date?: datetime
    end_date?: datetime
}

class TimePeriodOfDay {
    id*: uuid
    start_time: time
    end_time: time
}

class DayWeekMonth {
    id*: uuid
    applicable_day: enum["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"]
    applicable_month: enum["january", "february", "march", "april", "may", "june", "july", "august", "september", "october", "november", "december"]
}

class SpecialDay {
    id*: uuid
    type: enum["publicHoliday", "dayFollowingPublicHoliday", "longWeekendDay", "inLieuOfPublicHoliday", "schoolDay", "schoolHolidays", "publicEventDay", "other"]
}

User "1..N" -- "1..N" Organization
Organization "1..N" -- "1" RegulationOrderRecord
RegulationOrderRecord "1" -- "1" RegulationOrder
RegulationOrder "1" -- "1" RegulationCondition
RegulationCondition "0..1" -- "0..1" ConditionSet : condition_set
RegulationCondition "0..1" -- "0..N" ConditionSet : conditions
RegulationCondition "0..1" -- "1" VehicleCharacteristics : vehicle_condition
RegulationCondition "0..1" -- "1..1" OverallPeriod : validity_condition
RegulationCondition "0..1" -- "1" Location : location
OverallPeriod "0..N" -- "1" Period : valid_period
OverallPeriod "0..N" -- "1" Period : exception_period
Period "0..N" -- "1" TimePeriodOfDay : recurring_time_period_of_day
Period "0..N" -- "1" DayWeekMonth : recurring_day_week_month_period
Period "0..N" -- "1" SpecialDay : recurring_special_day
```

```mermaid
classDiagram
direction TB

class User

class Organization

class RegulationOrderRecord {
  id*: uuid
  created_at: datetime
  status: enum["draft", "published"]
}

class RegulationOrder {
  id*: uuid
  start_date: date
  end_date?: date
}

class Location {
  id*: uuid
  postal_code: str
  city: str
  street?: str
  from_house_number?: str
  from_point?: geometry
  to_house_number?: str
  to_point?: geometry
}

class Measure {
  id*: uuid
  type: enum["noEntry", "alternateRoad", "oneWayTraffic"]
}

class Condition {
    id*: uuid
    negate?: boolean
}

class VehicleCharacteristics {
  id*: uuid
  type: enum["anyVehicle", "lorry"]
  usage?: enum["roadMaintenanceOrConstruction"]
  max_length?: float
  max_height?: float
  max_weight?: float
  max_width?: float
}

class Period {
    id*: uuid
    applicable_days?: ARRAY[enum["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"]]
    applicable_months?: ARRAY[enum["january", "february", "march", "april", "may", "june", "july", "august", "september", "october", "november", "december"]]
    day_start_time?: time
    day_end_time?: time
    special_days?: ARRAY[enum["publicHoliday", "dayFollowingPublicHoliday", "longWeekendDay", "inLieuOfPublicHoliday", "schoolDay", "schoolHolidays", "publicEventDay", "other"]]
}

User "1..N" -- "1..N" Organization
Organization "0..N" -- "1..1" RegulationOrderRecord
RegulationOrderRecord "1" -- "1..1" RegulationOrder
RegulationOrder "1..N" -- "1..1" Location
Location "1..N" -- "1..1" Measure
Measure "0..N" -- "1..1" Condition
Condition "0..1" -- "1..1" VehicleCharacteristics : vehicle_condition
Condition "0..1" -- "1..1" Period : period_condition
```

```jsonc
{
    "type": "noEntry",
    "conditions": [
        {
            "vehicle_condition": {
                "type": "lorry",
            }
        },
        {
            "negate": true,
            "vehicle_condition": {
                "usage": "roadConstruction"
            }
        }
        {
            "period_condition": {
                "applicable_days": ["monday", "tuesday", "wednesday", "thursday", "friday"],
                "start_time": "08:00",
                "end_time": "12:00",
            }
        },
        {
            "negate": true,
            "period_condition": {
                "special_day": {
                    "type": "publicHoliday"
                }
            }
        }
    ]
}
```
